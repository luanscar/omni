generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

enum ChannelType {
  WHATSAPP
  INSTAGRAM
  TELEGRAM
  WEBCHAT
}

enum UserRole {
  ADMIN
  AGENT
  MANAGER
}

enum TeamRole {
  ADMIN
  MEMBER
}

enum ConversationStatus {
  OPEN
  CLOSED
  PENDING
}

enum MessageSenderType {
  USER
  CONTACT
  SYSTEM
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  LOCATION
  CONTACT
  STICKER
  REACTION
}

enum AuditEventType {
  MESSAGE // Mensagens WhatsApp
  USER_ACTION // Ações de usuários
  SYSTEM_EVENT // Eventos do sistema
  MEDIA_DOWNLOAD // Download de mídias
  AUTH // Autenticação
  DATA_CHANGE // Alteração de dados
  ERROR // Erros gerais
}

enum AuditStatus {
  SUCCESS
  FAILED
  PARTIAL // Parcialmente executado
  PENDING
}

// --- CORE SAAS MODELS ---

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  contacts      Contact[]
  channels      Channel[]
  teams         Team[]
  medias        Media[]
  conversations Conversation[]
  auditLogs     AuditLog[]

  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(AGENT)
  active    Boolean  @default(true)
  avatarUrl String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  teamMemberships TeamMember[]
  uploadedMedias  Media[]

  assignedConversations Conversation[] @relation("AssignedAgent")
  sentMessages          Message[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  auditLogs AuditLog[]

  @@map("users")
}

// --- OMNI CHANNEL MODELS ---

model Channel {
  id         String      @id @default(uuid())
  name       String
  type       ChannelType
  identifier String?
  token      String?
  active     Boolean     @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("channels")
}

model Contact {
  id            String  @id @default(uuid())
  name          String
  phoneNumber   String?
  email         String?
  profilePicUrl String?
  customFields  Json?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  conversations Conversation[]
  messages      Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phoneNumber, tenantId])
  @@map("contacts")
}

// --- TEAMS MODEL ---

model Team {
  id          String  @id @default(uuid())
  name        String
  description String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  members       TeamMember[]
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("teams")
}

model TeamMember {
  id String @id @default(uuid())

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role TeamRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, userId])
  @@map("team_members")
}

// --- MEDIA / STORAGE MODEL ---

model Media {
  id           String  @id @default(uuid())
  fileName     String
  originalName String
  mimeType     String
  size         Int
  key          String
  publicUrl    String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  uploaderId String?
  uploader   User?   @relation(fields: [uploaderId], references: [id], onDelete: SetNull)

  messages Message[]

  createdAt DateTime @default(now())

  @@map("medias")
}

// --- CORE MESSAGING MODELS ---

model Conversation {
  id         String @id @default(uuid())
  sequenceId Int    @default(autoincrement())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  channelId String?
  channel   Channel? @relation(fields: [channelId], references: [id])

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  assigneeId String?
  assignee   User?   @relation("AssignedAgent", fields: [assigneeId], references: [id])

  status ConversationStatus @default(OPEN)

  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("conversations")
}

model Message {
  id String @id @default(uuid())

  // ID da mensagem na plataforma externa (Ex: wamid.HBgL...)
  providerId String?

  type     MessageType @default(TEXT)
  content  String?
  metadata Json?

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderType MessageSenderType

  senderUserId String?
  senderUser   User?   @relation(fields: [senderUserId], references: [id])

  senderContactId String?
  senderContact   Contact? @relation(fields: [senderContactId], references: [id])

  mediaId String?
  media   Media?  @relation(fields: [mediaId], references: [id])

  // --- SUPORTE A REPLY ---
  quotedMessageId String?
  quotedMessage   Message?  @relation("QuotedMessage", fields: [quotedMessageId], references: [id])
  replies         Message[] @relation("QuotedMessage")

  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("messages")
}

// --- AUDITORIA ---

model AuditLog {
  id String @id @default(uuid())

  // Identificação
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Tipo de evento
  eventType AuditEventType
  module    String // whatsapp, messages, users, auth, etc
  action    String // message.received, message.sent, user.login, etc

  // Detalhes
  resource String? // ID do recurso afetado (messageId, userId, etc)
  details  Json? // Dados completos do evento

  // Status
  status       AuditStatus @default(SUCCESS)
  errorMessage String? // Se falhou, detalhe do erro

  // Metadata
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([eventType, status])
  @@index([module, action])
  @@index([resource])
  @@map("audit_logs")
}
